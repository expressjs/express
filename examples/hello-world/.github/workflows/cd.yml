name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Pull and run container
      run: |
        docker pull ghcr.io/sairamavvaru/hello-world-app:v1.0.0
        docker stop hello-world || true
        docker rm hello-world || true
        docker run -d --name hello-world -p 8080:8080 ghcr.io/sairamavvaru/hello-world-app:v1.0.0

  rollback:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
    - name: Rollback to previous version
      run: |
        docker pull ghcr.io/sairamavvaru/hello-world-app:v0.9.0
        docker stop hello-world || true
        docker rm hello-world || true
        docker run -d --name hello-world -p 8080:8080 ghcr.io/sairamavvaru/hello-world-app:v0.9.0
